
import { GoogleGenAI, Type } from "@google/genai";
import type { FormData, IngredientInfo } from '../types';

const API_KEY = process.env.API_KEY;

if (!API_KEY) {
    throw new Error("API_KEY environment variable not set");
}

const ai = new GoogleGenAI({ apiKey: API_KEY });

const SYSTEM_PROMPT = `
[ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ - AIì˜ ì—­í•  ì •ì˜]

ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ ì˜ì–‘ì‚¬ë¥¼ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ë ˆì‹œí”¼ ë° ì‹ë‹¨ í”Œë˜ë‹ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ ë§¤ì¼ 600ì¸ë¶„ì˜ ì ì‹¬ ì‹ì‚¬ë¥¼ ì¤€ë¹„í•´ì•¼ í•˜ëŠ” ì˜ì–‘ì‚¬ê°€ ë‹¤ì–‘í•œ ë©”ë‰´ë¥¼ ì‰½ê³  íš¨ìœ¨ì ìœ¼ë¡œ ê³„íší•˜ê³  ì¡°ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤. íŠ¹íˆ ëŒ€ëŸ‰ ì¡°ë¦¬ì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³ , ì˜ì–‘ ê· í˜•, ì•„ì´ë“¤ì˜ ì„ í˜¸ë„, ì‹ì¬ë£Œ ìˆ˜ê¸‰ ë° ì¡°ë¦¬ íš¨ìœ¨ì„±ì„ ê³ ë ¤í•œ ë ˆì‹œí”¼ë¥¼ ì œì•ˆí•´ì•¼ í•©ë‹ˆë‹¤.

[ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­ ë° ì¶œë ¥ í˜•ì‹]

ì‚¬ìš©ìì˜ ì…ë ¥ì— ë”°ë¼ ë‹¹ì‹ ì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë ˆì‹œí”¼ ë° ì‹ë‹¨ ì œì•ˆì„ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ì¶œë ¥ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ í•´ì£¼ì„¸ìš”. ì‹ë‹¨ ì œì•ˆ ë°”ë¡œ ë°‘ì—, ë©”ë‰´ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ì•Œë ˆë¥´ê¸° ìœ ë°œ ë¬¼ì§ˆì„ ë°˜ë“œì‹œ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.

[ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ]

ğŸ—“ï¸ 2024ë…„ 10ì›” 28ì¼ (ì›”ìš”ì¼) ì ì‹¬ ì‹ë‹¨ ì œì•ˆ (600ì¸ë¶„)

ğŸ½ï¸ ë©”ì¸ ë©”ë‰´: [AIê°€ ì œì•ˆí•˜ëŠ” ë©”ì¸ ë©”ë‰´ëª…] ([ë©”ì¸ ë©”ë‰´ ìœ í˜•])
ğŸ² êµ­/ì°Œê°œ: [AIê°€ ì œì•ˆí•˜ëŠ” êµ­ ë˜ëŠ” ì°Œê°œëª…]
ğŸš ë°¥: [AIê°€ ì œì•ˆí•˜ëŠ” ë°¥ ì¢…ë¥˜]
ğŸ¥¬ ë°˜ì°¬ 1: [AIê°€ ì œì•ˆí•˜ëŠ” ë°˜ì°¬ëª…]
ğŸ¥— ë°˜ì°¬ 2: [AIê°€ ì œì•ˆí•˜ëŠ” ë°˜ì°¬ëª…]
ğŸ¥¤ í›„ì‹: [AIê°€ ì œì•ˆí•˜ëŠ” í›„ì‹ëª…]

âš ï¸ ì•Œë ˆë¥´ê¸° ì •ë³´: [ë©”ë‰´ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ì•Œë ˆë¥´ê¸° ìœ ë°œ ë¬¼ì§ˆ ëª©ë¡ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë‚˜ì—´. ì˜ˆ: ìš°ìœ , ëŒ€ë‘, ë°€]

[ë©”ì¸ ë©”ë‰´ ë ˆì‹œí”¼ (600ì¸ë¶„ ê¸°ì¤€)]

ğŸ” ë©”ë‰´ëª…: [AIê°€ ì œì•ˆí•˜ëŠ” ë©”ì¸ ë©”ë‰´ëª…]
ğŸ¥˜ ìœ í˜•: [í•œì‹/ì–‘ì‹/ì¤‘ì‹ ë“±]

âœ¨ íŠ¹ì§•: [ë©”ë‰´ì˜ íŠ¹ì§•, ì•„ì´ë“¤ì´ ì¢‹ì•„í•  ë§Œí•œ ìš”ì†Œ, ì˜ì–‘ì  ì´ì  ë“±ì„ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…] ì˜ˆì‹œ: ìƒˆì½¤ë‹¬ì½¤í•œ ì†ŒìŠ¤ì™€ ë¶€ë“œëŸ¬ìš´ ìˆœì‚´ ë‹­ê³ ê¸°ê°€ ë§Œë‚˜ ì•„ì´ë“¤ì˜ ì…ë§›ì„ ë‹ìš°ëŠ” ì˜ì–‘ ë§Œì  ë©”ë‰´ì…ë‹ˆë‹¤. ì±„ì†Œë¥¼ ë“¬ë¿ ë„£ì–´ ë¹„íƒ€ë¯¼ê³¼ ì‹ì´ì„¬ìœ ë„ í’ë¶€í•´ìš”.

ğŸ“Š ì˜ì–‘ ì •ë³´ (1ì¸ ê¸°ì¤€, ì¶”ì •ì¹˜):
- ì¹¼ë¡œë¦¬: [ìˆ«ì] kcal
- ë‹¨ë°±ì§ˆ: [ìˆ«ì] g
- ì§€ë°©: [ìˆ«ì] g
- íƒ„ìˆ˜í™”ë¬¼: [ìˆ«ì] g
- ë‚˜íŠ¸ë¥¨: [ìˆ«ì] mg

ğŸ›’ ì¬ë£Œ (600ì¸ë¶„ ê¸°ì¤€):
- [ì¬ë£Œëª… 1]: [ì •ëŸ‰]
- [ì¬ë£Œëª… 2]: [ì •ëŸ‰]
- [ì¬ë£Œëª… 3]: [ì •ëŸ‰] (ì˜ˆ: íŒŒí”„ë¦¬ì¹´(ë¹¨ê°•, ë…¸ë‘): ê° 10kg)
... (ì´ 10~15ê°€ì§€ ì£¼ìš” ì¬ë£Œ)

ğŸ§‘â€ğŸ³ ì¡°ë¦¬ ê³¼ì •:
1. ì¬ë£Œ ì†ì§ˆ: ë‹­ê³ ê¸°ëŠ” í•œ ì… í¬ê¸°ë¡œ ì°ê³ , ì–‘íŒŒì™€ íŒŒí”„ë¦¬ì¹´ëŠ” ì±„ ì°ì–´ ì¤€ë¹„í•©ë‹ˆë‹¤.
2. ë°‘ê°„: ì†ì§ˆí•œ ë‹­ê³ ê¸°ì— [ê°„ì¥, ë§›ìˆ  ë“±]ì„ ë„£ì–´ ë°‘ê°„í•©ë‹ˆë‹¤. (ì•½ 15ë¶„)
3. ì†ŒìŠ¤ ì¤€ë¹„: ê°„ì¥, ì„¤íƒ•, ì‹ì´ˆ, ë‹¤ì§„ ë§ˆëŠ˜, ìƒê°•ì¦™ ë“±ì„ ì„ì–´ ì†ŒìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤. (ì •í™•í•œ ë¹„ìœ¨ ë° ì–‘ ëª…ì‹œ)
4. ë³¶ê¸°: ëŒ€í˜• ì›ì— ì‹ìš©ìœ ë¥¼ ë‘ë¥´ê³  ì–‘íŒŒ, íŒŒí”„ë¦¬ì¹´ë¥¼ ë¨¼ì € ë³¶ë‹¤ê°€ ë°‘ê°„í•œ ë‹­ê³ ê¸°ë¥¼ ë„£ì–´ ìµí™ë‹ˆë‹¤.
5. ë²„ë¬´ë¦¬ê¸°: ë‹­ê³ ê¸°ê°€ ê±°ì˜ ìµìœ¼ë©´ ì¤€ë¹„í•œ ì†ŒìŠ¤ë¥¼ ë„£ê³  ì„¼ ë¶ˆì—ì„œ ë¹ ë¥´ê²Œ ë²„ë¬´ë ¤ ì¡°ë¦¬í•©ë‹ˆë‹¤.
6. ë§ˆë¬´ë¦¬: ê¹¨ì†Œê¸ˆì„ ë¿Œë ¤ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.

ğŸ’¡ ëŒ€ëŸ‰ ì¡°ë¦¬ íŒ:
- ì¡°ë¦¬ ì‹œ ë‹­ê³ ê¸°ê°€ ë­‰ì¹˜ì§€ ì•Šë„ë¡ ë„“ì€ ì›ì—ì„œ ì†ŒëŸ‰ì”© ë‚˜ëˆ„ì–´ ë³¶ê±°ë‚˜, ì—¬ëŸ¬ ì¡°ë¦¬ ê¸°êµ¬ë¥¼ ë™ì‹œì— í™œìš©í•˜ì—¬ íš¨ìœ¨ì„ ë†’ì…ë‹ˆë‹¤.
- ì†ŒìŠ¤ëŠ” ë¯¸ë¦¬ ëŒ€ëŸ‰ìœ¼ë¡œ ë§Œë“¤ì–´ ë‘ì–´ ì¡°ë¦¬ ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤.
- ì˜¨ë„ ìœ ì§€ ë° ë°°ì‹ íš¨ìœ¨ì„±ì„ ìœ„í•´ ë³´ì˜¨ ë°°ì‹ ìš©ê¸°ë¥¼ ì¶©ë¶„íˆ í™œìš©í•©ë‹ˆë‹¤.
`;

function buildUserPrompt(formData: FormData): string {
    return `
[ì‚¬ìš©ì ì…ë ¥]
ë‚ ì§œ: ${formData.date}
ìš”ì¼: ${formData.day}
ë©”ì¸ ë©”ë‰´ í¬ë§ ìœ í˜•: ${formData.menuType}
ì£¼ìš” ì‹ì¬ë£Œ ì œí•œ/í¬í•¨: ${formData.ingredientConstraints || 'íŠ¹ë³„í•œ ì œí•œ/í¬í•¨ ì‚¬í•­ ì—†ìŒ'}
ì•Œë ˆë¥´ê¸° ìœ ë°œ ì‹ì¬ë£Œ ì œí•œ: ${formData.allergens.length > 0 ? formData.allergens.join(', ') : 'í•´ë‹¹ ì—†ìŒ'}
ì˜ì–‘ ê¸°ì¤€: ${formData.nutritionGoals || 'ì¼ë°˜ì ì¸ ì´ˆë“±í•™ìƒ ê¶Œì¥ ì˜ì–‘ ê¸°ì¤€'}
ì´ì „ ì‹ë‹¨ ë°ì´í„° (ì¤‘ë³µ ë°©ì§€ìš©): ${formData.previousMenus || 'ì´ì „ ë°ì´í„° ì—†ìŒ'}

ìœ„ ì‚¬ìš©ì ì…ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ, ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì˜ ì¶œë ¥ í˜•ì‹ì— ë§ì¶° ì™„ë²½í•œ ì‹ë‹¨ê³¼ ë ˆì‹œí”¼ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
    `;
}

export const generateMealPlan = async (formData: FormData): Promise<string> => {
  try {
    const userPrompt = buildUserPrompt(formData);
    
    const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: userPrompt,
        config: {
          systemInstruction: SYSTEM_PROMPT,
        }
    });
    
    return response.text;
  } catch (error) {
    console.error("Error generating meal plan:", error);
    throw new Error("Failed to communicate with the AI model.");
  }
};

export const generateIngredientInfo = async (ingredientsText: string): Promise<IngredientInfo[]> => {
    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: `
                ë‹¤ìŒ ì‹ì¬ë£Œ ëª©ë¡ì— ëŒ€í•œ í˜„ì¬ ìˆ˜ê¸‰ ìƒí™©ê³¼ ì˜ˆìƒ ê°€ê²© ì •ë³´ë¥¼ ë¶„ì„í•´ì¤˜.
                ê²°ê³¼ëŠ” ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì•¼ í•´. 'status' í•„ë“œ ê°’ì€ 'ì›í™œ', 'ë³´í†µ', 'ë¶€ì¡±' ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•´.
                ê°€ê²©ì€ 600ì¸ë¶„ ê¸°ì¤€ì´ ì•„ë‹Œ, ì¼ë°˜ì ì¸ ì‹œì¥ ë‹¨ìœ„(ì˜ˆ: kg, ë‹¨) ê¸°ì¤€ìœ¼ë¡œ ì•Œë ¤ì¤˜.
                'notes' í•„ë“œì—ëŠ” ê°€ê²© ë³€ë™ ìš”ì¸ì´ë‚˜ ëŒ€ì²´ì¬ ì œì•ˆ ë“± ìœ ìš©í•œ ì •ë³´ë¥¼ ì¶”ê°€í•´ì¤˜.

                [ì‹ì¬ë£Œ ëª©ë¡]
                ${ingredientsText}
            `,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.ARRAY,
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            name: { type: Type.STRING, description: 'ì‹ì¬ë£Œ ì´ë¦„' },
                            price: { type: Type.STRING, description: 'ì˜ˆìƒ ì‹œì¥ ê°€ê²© (ë‹¨ìœ„ í¬í•¨)' },
                            status: { type: Type.STRING, description: 'ìˆ˜ê¸‰ í˜„í™© (ì›í™œ, ë³´í†µ, ë¶€ì¡±)' },
                            notes: { type: Type.STRING, description: 'ê°€ê²© ë³€ë™ ìš”ì¸, ëŒ€ì²´ì¬ ë“± ì¶”ê°€ ì •ë³´' }
                        },
                        required: ['name', 'price', 'status', 'notes']
                    }
                }
            }
        });

        const jsonString = response.text.trim();
        const data = JSON.parse(jsonString);
        return data as IngredientInfo[];

    } catch (error) {
        console.error("Error generating ingredient info:", error);
        throw new Error("Failed to communicate with the AI model for ingredient data.");
    }
};
